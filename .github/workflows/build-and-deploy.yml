name: Build, Test, Migrate and Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: windows-latest

    env:
      DOTNET_VERSION: '8.0.x'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore Dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Run Tests
      run: dotnet test --no-build --verbosity normal

    - name: EF Core Database Update (ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰)
      run: dotnet ef database update --project ProductionSystem.Web
      env:
        ASPNETCORE_ENVIRONMENT: Production

    # â¬‡ï¸ Azure App Service ë°°í¬ ì˜ˆì‹œ (ì„ íƒ)
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: AzureTestWeb
        slot-name: production
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
        package: ./ProductionSystem.Web

    # â¬‡ï¸ IIS FTP ë°°í¬ ì˜ˆì‹œ (Azure ëŒ€ì‹ )
    # - name: FTP Deploy to IIS Server
    #   uses: SamKirkland/FTP-Deploy-Action@v4
    #   with:
    #     server: ${{ secrets.FTP_SERVER }}
    #     username: ${{ secrets.FTP_USERNAME }}
    #     password: ${{ secrets.FTP_PASSWORD }}
    #     local-dir: ./ProductionSystem.Web/bin/Release/net8.0/publish

    - name: Slack ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œë§Œ)
      if: failure()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_MESSAGE: "ğŸš¨ GitHub Actions ì‹¤íŒ¨: ${{ github.workflow }} | ${{ github.ref }}"

    - name: ì´ë©”ì¼ ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸ”´ GitHub Actions ì‹¤íŒ¨ ì•Œë¦¼"
        body: "âŒ ë¹Œë“œ ë˜ëŠ” ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\në¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}\në¸Œëœì¹˜: ${{ github.ref }}"
        to: jingeun@example.com
        from: GitHub CI